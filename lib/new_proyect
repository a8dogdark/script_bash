#!/bin/bash

# =========================================================
# Script Creador de Proyectos Laravel
# Versión 2.3 - Corregido: Solucionado el problema con la escritura
# de la contraseña de la base de datos en el archivo .env.
# =========================================================

clear

# ---------------------------------------------------------
# Declaración de variables
# ---------------------------------------------------------
DBSERVER=""
DISTRO=""
PASSROOT=""
DBUSER=""
DBPASS=""
PROYECTO=""
VER="2.3"
ROOT_DB_CONNECTED=false

# ---------------------------------------------------------
# Validar si se ejecuta como root
# ---------------------------------------------------------
if [[ "$EUID" -ne 0 ]]; then
    echo "Error: Este script debe ser ejecutado como usuario root." 1>&2
    exit 1
fi

# ---------------------------------------------------------
# Validar si el sistema es de 64 bits
# ---------------------------------------------------------
if [[ "$(uname -m)" != "x86_64" ]]; then
    echo "Error: Este script es solo para sistemas de 64 bits (x86_64)." 1>&2
    exit 1
fi

# Validar que sea Ubuntu, Debian o AnduinOS, y definir DISTRO
if grep -qi 'AnduinOS' /etc/os-release; then
    DISTRO="AnduinOS"
elif grep -qi 'Ubuntu' /etc/os-release; then
    DISTRO="Ubuntu"
elif grep -qi 'Debian' /etc/os-release; then
    DISTRO="Debian"
else
    echo "Este script solo puede ejecutarse en Ubuntu, Debian o AnduinOS."
    exit 1
fi

# ---------------------------------------------------------
# Instalar whiptail si no está presente
# ---------------------------------------------------------
if ! command -v whiptail &> /dev/null; then
    apt update >/dev/null 2>&1
    apt install -y whiptail >/dev/null 2>&1
    sleep 1
fi

# ---------------------------------------------------------
# Cuadro de bienvenida
# ---------------------------------------------------------
if (whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Bienvenido" --yesno "Bienvenido al Creador de Proyectos Laravel.\n\nEste script creará un nuevo proyecto Laravel asumiendo que ya tienes instalado:\n- Apache\n- PHP\n- MySQL/MariaDB\n- Composer\n- NodeJs\n\n¿Desea continuar?" 15 70) then
    # El usuario seleccionó Aceptar, se continúa
    echo ""
else
    # El usuario seleccionó Cancelar, se sale del script
    whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Cancelado" --msgbox "Has cancelado la creación del proyecto." 8 40
    exit 1
fi

# ---------------------------------------------------------
# Preguntar y validar el nombre del proyecto Laravel
# ---------------------------------------------------------
# Encontrar el próximo nombre de proyecto disponible por defecto
default_name="crud"
i=0
unique_name="$default_name"
while [ -d "/var/www/laravel/$unique_name" ]; do
    i=$((i+1))
    unique_name="${default_name}${i}"
done

# Bucle para preguntar y validar el nombre del proyecto
while true; do
    PROYECTO=$(whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Nombre del Proyecto Laravel" --inputbox "Por favor, introduce el nombre del proyecto a crear en /var/www/laravel/:\n(Si lo dejas en blanco, se usará '$unique_name' por defecto)" 10 70 "$unique_name" 3>&1 1>&2 2>&3)
        
    if [ $? -ne 0 ]; then
        whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Cancelado" --msgbox "Has cancelado la creación del proyecto." 8 40
        exit 1
    fi

    # Asignar el valor por defecto si el campo se deja en blanco
    if [ -z "$PROYECTO" ]; then
        PROYECTO="$unique_name"
    fi

    # Validar si el directorio ya existe
    if [ -d "/var/www/laravel/$PROYECTO" ]; then
        whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Error" --msgbox "La carpeta '/var/www/laravel/$PROYECTO' ya existe. Por favor, elige otro nombre." 10 70
    else
        break
    fi
done

# ---------------------------------------------------------
# Validar la conexión del usuario root de la base de datos
# ---------------------------------------------------------
if mysql -u root -e "exit" >/dev/null 2>&1; then
    ROOT_DB_CONNECTED=true
else
    while true; do
        PASSROOT=$(whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Contraseña de Root para la Base de Datos" --passwordbox "Por favor, introduce la contraseña del usuario 'root' de la base de datos.\n\nEsta es necesaria para crear la base de datos y un nuevo usuario con permisos." 10 70 "" 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then
            whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Cancelado" --msgbox "Has cancelado la creación del proyecto." 8 40
            exit 1
        fi
        
        if mysql -u root -p"$PASSROOT" -e "exit" >/dev/null 2>&1; then
            ROOT_DB_CONNECTED=true
            break
        else
            whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Error de Autenticación" --msgbox "La contraseña de root es incorrecta. Por favor, inténtalo de nuevo." 10 70
        fi
    done
fi

if ! $ROOT_DB_CONNECTED; then
    whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Error Crítico" --msgbox "No se pudo conectar como usuario 'root' a la base de datos. Por favor, verifica tu instalación de MySQL/MariaDB y la configuración de la contraseña." 12 70
    exit 1
fi


# ---------------------------------------------------------
# Seleccionar o crear un nuevo usuario de base de datos
# ---------------------------------------------------------
# Obtener la lista de usuarios de la base de datos, incluyendo 'root'
DB_USERS=$(mysql -u root -p"$PASSROOT" -Bse "SELECT User FROM mysql.user WHERE User NOT IN ('mysql.infoschema', 'mysql.sys', 'mysql.session', 'mysql.user', 'debian-sys-maint');" | tr '\n' ' ')
DB_USERS_ARRAY=($DB_USERS)

# Agregar la opción de crear un nuevo usuario
DB_USERS_MENU=("Crear nuevo usuario" " (por defecto) ")
if [ ${#DB_USERS_ARRAY[@]} -gt 0 ]; then
    for user in "${DB_USERS_ARRAY[@]}"; do
        DB_USERS_MENU+=("$user" " (existente) ")
    done
fi

DB_SELECTION=$(whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Selección de Usuario de la Base de Datos" --menu "Por favor, elige un usuario de la base de datos para el proyecto o crea uno nuevo.\n\n" 18 70 8 "${DB_USERS_MENU[@]}" 3>&1 1>&2 2>&3)

if [ $? -ne 0 ]; then
    whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Cancelado" --msgbox "Has cancelado la creación del proyecto." 8 40
    exit 1
fi

if [ "$DB_SELECTION" == "Crear nuevo usuario" ]; then
    # Encontrar el próximo nombre de usuario 'user' disponible
    default_user="user"
    i=0
    unique_user=""
    while [ -z "$unique_user" ]; do
        i=$((i+1))
        temp_user="${default_user}${i}"
        if ! mysql -u root -p"$PASSROOT" -e "SELECT User FROM mysql.user WHERE User = '$temp_user';" | grep -q "$temp_user"; then
            unique_user="$temp_user"
        fi
    done

    # Si se elige crear nuevo usuario, preguntar por el nombre y la contraseña
    while true; do
        DBUSER=$(whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Nombre del Nuevo Usuario de la Base de Datos" --inputbox "Introduce el nombre del nuevo usuario para la base de datos.\n\n(Por defecto se usará '$unique_user')" 10 70 "$unique_user" 3>&1 1>&2 2>&3)
        if [ $? -ne 0 ]; then
            whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Cancelado" --msgbox "Has cancelado la creación del proyecto." 8 40
            exit 1
        fi
        
        if [ -z "$DBUSER" ]; then
            DBUSER="$unique_user"
        fi

        if mysql -u root -p"$PASSROOT" -e "SELECT User FROM mysql.user WHERE User = '$DBUSER';" | grep -q "$DBUSER"; then
            whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Error" --msgbox "El usuario '$DBUSER' ya existe. Por favor, elige un nombre diferente." 10 70
        else
            break
        fi
    done

    # Pedir la nueva contraseña para el usuario
    DBPASS=$(whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Contraseña del Nuevo Usuario" --passwordbox "Introduce una contraseña para el nuevo usuario de la base de datos:\n(Si la dejas en blanco, se usará '12345' por defecto)" 10 70 "" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
        whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Cancelado" --msgbox "Has cancelado la creación del proyecto." 8 40
        exit 1
    fi
    if [ -z "$DBPASS" ]; then
        DBPASS="12345"
    fi
    
else
    # Si se elige un usuario existente, usarlo
    DBUSER="$DB_SELECTION"
    
    # Si el usuario es 'root', usamos la contraseña ya validada
    if [ "$DBUSER" == "root" ]; then
        DBPASS="$PASSROOT"
    else
        # Para otros usuarios existentes, asumimos que no tienen contraseña
        DBPASS=""
    fi
    whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Usuario Existente Seleccionado" --msgbox "Has seleccionado el usuario '$DBUSER'. Se utilizará este usuario para el nuevo proyecto." 10 70
fi


# ---------------------------------------------------------
# Barra de progreso para la creación del proyecto
# ---------------------------------------------------------
(
    # Paso 1: Crear carpeta para proyectos Laravel
    echo "XXX"
    echo "5"
    echo "Creando carpeta para proyectos Laravel (/var/www/laravel)..."
    echo "XXX"
    mkdir -p "/var/www/laravel" >/dev/null 2>&1
    chown -R www-data:www-data "/var/www/laravel" >/dev/null 2>&1
    chmod -R 775 "/var/www/laravel" >/dev/null 2>&1
    sleep 2

    # Paso 2: Crear proyecto de Laravel
    echo "XXX"
    echo "15"
    echo "Creando proyecto de Laravel '$PROYECTO' (esto puede tardar varios minutos)..."
    echo "XXX"
    USER_PROYECTO=${SUDO_USER:-$(whoami)}
    sudo -u "$USER_PROYECTO" composer create-project --no-interaction laravel/laravel "/var/www/laravel/$PROYECTO" >/dev/null 2>&1
    sleep 1

    # Paso 3: Instalar dependencias de Node.js
    echo "XXX"
    echo "25"
    echo "Instalando dependencias de Node.js para Vite..."
    echo "XXX"
    sudo -u "$USER_PROYECTO" npm --prefix "/var/www/laravel/$PROYECTO" install >/dev/null 2>&1
    sleep 1

    # Paso 4: Compilar los assets con Vite
    echo "XXX"
    echo "35"
    echo "Compilando los assets con Vite..."
    echo "XXX"
    sudo -u "$USER_PROYECTO" npm --prefix "/var/www/laravel/$PROYECTO" run build >/dev/null 2>&1
    sleep 1
    
    # Paso 5: Instalar paquete de idioma español
    echo "XXX"
    echo "45"
    echo "Instalando el paquete de idioma español para Laravel..."
    echo "XXX"
    sudo -u "$USER_PROYECTO" composer --working-dir="/var/www/laravel/$PROYECTO" require laravel-lang/lang --dev --no-interaction >/dev/null 2>&1
    sleep 1
    
    # Paso 6: Configurar el idioma predeterminado del proyecto a español
    echo "XXX"
    echo "55"
    echo "Configurando el idioma predeterminado del proyecto a español..."
    echo "XXX"
    sed -i "s/\('locale' =>\s*\) 'en'/\1 'es'/" "/var/www/laravel/$PROYECTO/config/app.php"
    sleep 1

    # Paso 7: Configurar dominio local
    echo "XXX"
    echo "65"
    echo "Configurando dominio local para el proyecto..."
    echo "XXX"
    
    VHOST_CONF_FILE="/etc/apache2/sites-available/$PROYECTO.test.conf"
    cat <<EOF > "$VHOST_CONF_FILE"
<VirtualHost *:80>
    ServerName $PROYECTO.test
    DocumentRoot /var/www/laravel/$PROYECTO/public

    <Directory /var/www/laravel/$PROYECTO/public>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog \${APACHE_LOG_DIR}/$PROYECTO.test-error.log
    CustomLog \${APACHE_LOG_DIR}/$PROYECTO.test-access.log combined
</VirtualHost>
EOF
    
    a2ensite "$PROYECTO.test.conf" >/dev/null 2>&1
    systemctl reload apache2 >/dev/null 2>&1

    if ! grep -q "$PROYECTO.test" /etc/hosts; then
        echo "127.0.0.1 $PROYECTO.test" >> /etc/hosts
    fi
    sleep 2
    
    # Paso 8: Configurar base de datos y correr migraciones
    echo "XXX"
    echo "75"
    echo "Configurando la base de datos y ejecutando las migraciones..."
    echo "XXX"
    
    USER_PROYECTO=${SUDO_USER:-$(whoami)}
    PROJECT_PATH="/var/www/laravel/$PROYECTO"

    # Eliminar las líneas de la base de datos existentes
    sed -i '/^DB_CONNECTION=/d' "$PROJECT_PATH/.env"
    sed -i '/^DB_HOST=/d' "$PROJECT_PATH/.env"
    sed -i '/^DB_PORT=/d' "$PROJECT_PATH/.env"
    sed -i '/^DB_DATABASE=/d' "$PROJECT_PATH/.env"
    sed -i '/^DB_USERNAME=/d' "$PROJECT_PATH/.env"
    sed -i '/^DB_PASSWORD=/d' "$PROJECT_PATH/.env"
    
    # Agregar las nuevas líneas de la base de datos
    {
        echo "DB_CONNECTION=mysql"
        echo "DB_HOST=127.0.0.1"
        echo "DB_PORT=3306"
        echo "DB_DATABASE=$PROYECTO"
        echo "DB_USERNAME=$DBUSER"
        echo "DB_PASSWORD=\"$DBPASS\""
    } >> "$PROJECT_PATH/.env"
    
    # Configurar la URL de la aplicación
    sed -i "s|^APP_URL=.*|APP_URL=http://$PROYECTO.test|" "$PROJECT_PATH/.env"

    chown "$USER_PROYECTO":www-data "$PROJECT_PATH/.env"

    mysql -u root -p"$PASSROOT" -e "CREATE DATABASE IF NOT EXISTS $PROYECTO;" >/dev/null 2>&1
    
    if [ "$DBUSER" != "root" ] && [ ! -z "$DBPASS" ]; then
        # Crear el usuario si no es 'root' y si se definió una nueva contraseña
        mysql -u root -p"$PASSROOT" -e "CREATE USER IF NOT EXISTS '$DBUSER'@'localhost' IDENTIFIED BY '$DBPASS';" >/dev/null 2>&1
    fi
    mysql -u root -p"$PASSROOT" -e "GRANT ALL PRIVILEGES ON $PROYECTO.* TO '$DBUSER'@'localhost';" >/dev/null 2>&1
    mysql -u root -p"$PASSROOT" -e "FLUSH PRIVILEGES;" >/dev/null 2>&1

    sudo -u "$USER_PROYECTO" php "/var/www/laravel/$PROYECTO/artisan" migrate >/dev/null 2>&1
    sleep 2
    
    # Paso 9: Crear enlace simbólico para el almacenamiento
    echo "XXX"
    echo "85"
    echo "Creando enlace simbólico para el almacenamiento (storage:link)..."
    echo "XXX"
    sudo -u "$USER_PROYECTO" php "/var/www/laravel/$PROYECTO/artisan" storage:link >/dev/null 2>&1
    sleep 2
    
    # Paso 10: Configurar permisos finales para el proyecto
    echo "XXX"
    echo "95"
    echo "Configurando permisos finales para el proyecto..."
    echo "XXX"
    USER_PROYECTO=${SUDO_USER:-$(whoami)}
    PROJECT_PATH="/var/www/laravel/$PROYECTO"
    
    chown -R "$USER_PROYECTO":www-data "$PROJECT_PATH" >/dev/null 2>&1
    chmod -R 777 "$PROJECT_PATH" >/dev/null 2>&1
    sleep 2
    
    
    # Paso Final: Fin de la instalación
    echo "XXX"
    echo "100"
    echo "Fin del Proceso de Creación de Proyecto"
    echo "XXX"
    sleep 3
    
) | whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Creando proyecto..." --gauge "Iniciando la creación del proyecto..." 6 60 0

# ---------------------------------------------------------
# Mensaje final de éxito
# ---------------------------------------------------------

# Mensaje de éxito
if [ "$DBUSER" == "root" ]; then
    DB_DETAILS="Usuario de la DB: $DBUSER\nContraseña de la DB: (se utilizó la de root)\n"
elif [ -z "$DBPASS" ]; then
    DB_DETAILS="Usuario de la DB: $DBUSER\nContraseña de la DB: (Existente - no se modificó)\n"
else
    DB_DETAILS="Usuario de la DB: $DBUSER\nContraseña de la DB: $DBPASS\n"
fi

whiptail --backtitle "Creador de Proyectos Laravel V$VER" --title "Creación completada" --msgbox "El proyecto de Laravel '$PROYECTO' ha sido creado y configurado con éxito.\n\nEl proyecto se encuentra en: /var/www/laravel\n\nAhora puedes acceder a tu proyecto en: http://$PROYECTO.test\n\n$DB_DETAILS\nSe han ejecutado las migraciones de la base de datos y se ha creado el enlace simbólico de 'storage' con éxito." 19 70

exit 0
